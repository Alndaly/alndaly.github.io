"use strict";(self.webpackChunkclassic=self.webpackChunkclassic||[]).push([[4414],{75606:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var t=r(87462),a=(r(67294),r(3905));r(16758);const s={},o=void 0,i={unversionedId:"frontend/\u65e0\u611f\u5237\u65b0token",id:"frontend/\u65e0\u611f\u5237\u65b0token",title:"\u65e0\u611f\u5237\u65b0token",description:"",source:"@site/docs/frontend/\u65e0\u611f\u5237\u65b0token.md",sourceDirName:"frontend",slug:"/frontend/\u65e0\u611f\u5237\u65b0token",permalink:"/docs/frontend/\u65e0\u611f\u5237\u65b0token",draft:!1,editUrl:"https://github.com/alndaly/alndaly.github.io/edit/master/docs/frontend/\u65e0\u611f\u5237\u65b0token.md",tags:[],version:"current",lastUpdatedAt:1693833086,formattedLastUpdatedAt:"2023\u5e749\u67084\u65e5",frontMatter:{},sidebar:"frontEndSidebar",previous:{title:"\u6570\u7ec4\u65b9\u6cd5",permalink:"/docs/frontend/\u6570\u7ec4\u65b9\u6cd5"},next:{title:"overflow-wrap",permalink:"/docs/frontend/\u884c\u6ea2\u51fa"}},c={},l=[],d={toc:l};function u(e){let{components:n,...r}=e;return(0,a.kt)("wrapper",(0,t.Z)({},d,r,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=request.ts",title:"request.ts"},"import { v4 as uuidv4 } from 'uuid';\nimport cache from '@/utils/cache/index';\nimport { userStore } from 'stores/user';\nimport message from '../message';\n\ninterface ApiData {\n  code: number,\n  message: string,\n  data: any,\n}\n\n// \u9ed8\u8ba4\u5237\u65b0\u72b6\u6001\uff0c\u786e\u4fdd\u4e00\u65e6\u9047\u5230token\u8fc7\u671f\u7684\u72b6\u51b5\u5c31\u80fd\u66f4\u65b0\nlet isTokenRefreshing = true;\n// \u9632\u6b62\u591a\u6b21\u8bf7\u6c42token\u83b7\u53d6\u63a5\u53e3\uff08\u9650\u5236\u4e09\u6b21\uff0c\u4e09\u6b21\u4ee5\u540e\u76f4\u63a5\u663e\u793a\u8d26\u53f7\u4fe1\u606f\u9519\u8bef\uff09\nlet refreshTokenTimes = 0;\n// \u9632\u6b62access_token\u9519\u8bef\u60c5\u51b5\u4e0b\u800crefresh_token\u7684\u65e0\u9650\u8bf7\u6c42\u8fb9\u9645\u60c5\u51b5\n// let wrongAuth = 0;\n// \u88ab\u62e6\u622a\u7684\u8bf7\u6c42\u6570\u7ec4\nlet subscribers: any[] = [];\n\n// \u5904\u7406\u88ab\u7f13\u5b58\u7684\u8bf7\u6c42\nfunction onAccessTokenFetched() {\n  subscribers.forEach((callback) => {\n    callback();\n  });\n  // \u5904\u7406\u5b8c\u540e\u6e05\u7a7a\u7f13\u5b58\u8bf7\u6c42\u6570\u7ec4\n  subscribers = [];\n}\n\nasync function refreshToken() {\n  if (refreshTokenTimes >= 3) {\n    message.error('\u767b\u9646\u4fe1\u606f\u5df2\u8fc7\u671f\uff0c\u5373\u5c06\u8df3\u8f6c\u5230\u767b\u9646\u9875\u9762');\n    cache.clear()\n    setTimeout(() => {\n      window.location.reload()\n    }, 1000)\n    return;\n  }\n  isTokenRefreshing = true;\n  refreshTokenTimes++;\n  const user = userStore();\n  const res = await user.onUpdateToken();\n  isTokenRefreshing = false;\n  if (res && res.code === 20000) {\n    onAccessTokenFetched();\n  } else {\n    refreshToken()\n  }\n}\n\n// \u5c06\u8bf7\u6c42\u7f13\u5b58\u5230\u8bf7\u6c42\u6570\u7ec4\u4e2d\nfunction addSubscriber(callback: any) {\n  subscribers.push(callback)\n}\n\n\nconst checkTokenRefreshStatus = (url: string, data: any, method: any) => {\n  // \u5237\u65b0token\u7684\u51fd\u6570,\u8fd9\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a\u5f00\u5173\uff0c\u9632\u6b62\u91cd\u590d\u8bf7\u6c42\n  if (isTokenRefreshing) {\n    refreshToken();\n  }\n  isTokenRefreshing = false;\n  // \u5c06\u5f53\u524d\u7684\u8bf7\u6c42\u4fdd\u5b58\u5728\u89c2\u5bdf\u8005\u6570\u7ec4\u4e2d\n  const retryOriginalRequest = new Promise((resolve) => {\n    addSubscriber(() => {\n      resolve(request(url, data, method));\n    });\n  });\n  return retryOriginalRequest;\n};\n\nexport const request = (url: string, data: any, method: 'POST' | 'GET') => {\n  // \u9632\u6b62access_token\u9519\u8bef\u60c5\u51b5\u4e0b\u800crefresh_token\u7684\u65e0\u9650\u8bf7\u6c42\u8fb9\u9645\u60c5\u51b5\uff0c\u6b64\u65f6\u63d0\u9192\u7528\u6237\u91cd\u65b0\u767b\u9646\n  // if (wrongAuth >= 5) {\n  //   message.error('\u591a\u4e2a\u8bf7\u6c42\u6388\u6743\u5931\u8d25\uff0c\u91cd\u65b0\u767b\u9646\u4e0b\uff1f')\n  //   return\n  // }\n  const headers = new Headers();\n  headers.append('Content-Type', 'application/json');\n  if (cache.get('access_token')) {\n    headers.append('Authorization', 'Bearer ' + cache.get('access_token'));\n  }\n  return new Promise(async (resolve, reject) => {\n    const response = await fetch(url, {\n      method: method, // *GET, POST, PUT, DELETE, etc.\n      mode: 'cors', // no-cors, *cors, same-origin\n      cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached\n      credentials: 'same-origin', // include, *same-origin, omit\n      headers: headers,\n      redirect: 'follow', // manual, *follow, error\n      referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url\n      body: JSON.stringify({ ...data, traceId: uuidv4() }) // body data type must match \"Content-Type\" header\n    });\n    // \u8bf7\u6c42\u51fa\u9519\n    if (response && response.status !== 200) {\n      // \u6743\u9650\u95ee\u9898\n      if (response.status === 401) {\n        // const backData: ApiData = await response.json()\n        // \u6ce8\u610f\u6b64\u5904\u5982\u679c\u8fc7\u671f\u4e86\u90a3\u4e48\u4f1a\u76f4\u63a5\u88ab\u540e\u7aef\u62e6\u622a\uff0c\u4e0d\u4f1a\u6709code\u7b49\u4fe1\u606f\uff0c\u6240\u4ee5\u63a5\u53e3\u7c7b\u4e0d\u9002\u7528\n        // @ts-ignore\n        // if (backData?.detail === '\u8eab\u4efd\u8ba4\u8bc1\u4fe1\u606f\u672a\u63d0\u4f9b\u3002') {\n        resolve(checkTokenRefreshStatus(url, data, method))\n        // }\n      }\n    }\n    // \u8bf7\u6c42\u6b63\u5e38\n    const backData: ApiData = await response.json()\n    if (backData && backData.code !== 20000) {\n      reject(backData)\n      return\n    } else {\n      resolve(backData)\n    }\n  })\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title=index.ts",title:"index.ts"},"import { request } from './request';\n\n/**\n * @param {string} url\n * @param {object} query\n * @returns {Promise<any>}\n * @description \u53d1\u9001get\u8bf7\u6c42\n**/\nexport async function get(url = '', data = {}) {\n  const res = request(url, data, 'GET');\n  return res\n}\n\n/**\n * @param {string} url\n * @param {object} query\n * @returns {Promise<any>}\n * @description \u53d1\u9001post\u8bf7\u6c42\n**/\nexport async function post(url = '', data = {}) {\n  const res = request(url, data, 'POST');\n  return res\n}\n\n/**\n * \u5c06promise\u5bf9\u8c61\u8fd4\u56de\u51fd\u6570\u8f6c\u4e3a\u6570\u7ec4\n * @param promise\n * @returns []\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function to(promise: Promise<any>): Promise<any[]> {\n  return new Promise((resolve) => {\n    promise.then(\n      (res) => {\n        return resolve([res, null])\n      },\n      (err) => {\n        return resolve([null, err])\n      }\n    );\n  }\n  );\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:"cache.ts","cache.ts":!0},"export default {\n  // \u6b64\u5904expire\u662f\u5206\u949f\u6570\n  set(key: string, val: any, expire?: number) {\n    try {\n      let data;\n      let dataObj: any;\n      const curTime = data ? dataObj.saveTime : new Date().getTime();\n      expire = expire ? (data ? dataObj.expire : (1000 * expire)) : null;\n      localStorage.setItem(key, JSON.stringify({\n        data: val,\n        saveTime: curTime,\n        expire\n      }));\n    } catch (e) {\n      console.log(e);\n    }\n  },\n\n  // \u5224\u65ad\u662f\u5426\u8fc7\u671f\n  expired(key: string) {\n    try {\n      const data = localStorage.getItem(key);\n      if (data) {\n        const dataObj = JSON.parse(data);\n        if (dataObj.expire && new Date().getTime() - dataObj.saveTime > dataObj.expire) {\n          return true\n        } else {\n          return false\n        }\n      }\n    } catch (e) {\n      console.error(e);\n    }\n  },\n\n  get(key: string) {\n    try {\n      const data = localStorage.getItem(key);\n      if (data) {\n        const dataObj = JSON.parse(data);\n        if (dataObj.expire && new Date().getTime() - dataObj.saveTime > dataObj.expire) {\n          // TODO: \u6b64\u5904token\u5220\u9664\u903b\u8f91\u653e\u5230\u4e1a\u52a1\u5c42\u53bb\n          // this.remove(key)\n          // return null\n          return dataObj.data\n        } else {\n          return dataObj.data\n        }\n      }\n      return null\n    } catch (e) {\n      console.error(e);\n    }\n  },\n\n  remove(key: string) {\n    try {\n      localStorage.removeItem(key);\n    } catch (e) {\n      // error\n      console.error(e);\n    }\n  },\n\n  clear() {\n    try {\n      localStorage.clear();\n    } catch (e) {\n      // error\n      console.error(e);\n    }\n  }\n}\n")))}u.isMDXComponent=!0}}]);